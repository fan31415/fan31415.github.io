<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo-32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo-16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.ong?v=5.1.4" color="#222">





  <meta name="keywords" content="fanyijie, technology" />










<meta property="og:type" content="website">
<meta property="og:title" content="Fan&#39;s Home">
<meta property="og:url" content="https://fanyijie.net/index.html">
<meta property="og:site_name" content="Fan&#39;s Home">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fan&#39;s Home">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://fanyijie.net/"/>





  <title>Fan's Home</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Fan's Home</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fanyijie.net/2018/08/04/Blog迁移/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fan Yijie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fan's Home">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/04/Blog迁移/" itemprop="url">Blog迁移~</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-08-04T17:16:26+08:00">
                2018-08-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>因为种种原因，决定将blog迁移到github上，比较喜欢用Markdown写作然后直接push的感觉，感觉可以更好的回归到博客的本质上。在迁移之后我对博客定位也发生了一些改变，毕竟距离这个博客首次发文也已经两三年了，以后发的东西不会那么concentrate在技术上面，还会有其他的一些杂七杂八的分享。之前的服务器也会继续使用一段时间，但是暂时就不更新啦。我会对这个新家继续修修补补的，积累了好多一直没发布的东西也会陆陆续续发布的。最后，虽说主要都是为了自己记录，写的也比较随心的说，还是要说一句，欢迎大家批评讨论啊！My email address: <a href="mailto:fanyije@gmail.com" target="_blank" rel="noopener">fanyije@gmail.com</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fanyijie.net/2018/05/14/trouble-shooting-on-eos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fan Yijie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fan's Home">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/14/trouble-shooting-on-eos/" itemprop="url">Trouble Shooting on EOS</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-14T11:45:01+08:00">
                2018-05-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/eos/" itemprop="url" rel="index">
                    <span itemprop="name">eos</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>Error: <code>last block ID does not match current chain state</code> Workaround: <code>./nodeos --resync</code></p>
</li>
<li><p>Error: <code>Error 3040002: Invalid Action Arguments</code></p>
</li>
</ul>
<ol>
<li>Type wrong method name, check the spelling.</li>
<li>Did not include the action method in <code>EOS_ABI</code> macro.</li>
<li>If not reasons above, check the .abi file.</li>
</ol>
<ul>
<li><p>Error: compile error and show <code>normalization:</code> after your <code>action</code> name Usually you use Capital or underscore in your action name. Replace it with lowercase version.</p>
</li>
<li><p>Error: <code>key is undefined</code> when push action. usually you invoke some key not exist in your table (multi_Index), check the codes near the table.</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fanyijie.net/2018/05/08/the-difference-of-ether-and-eos-token-in-code-hierarchy-aspect/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fan Yijie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fan's Home">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/08/the-difference-of-ether-and-eos-token-in-code-hierarchy-aspect/" itemprop="url">The difference of Ether and EOS token in code hierarchy aspect</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-08T21:51:25+08:00">
                2018-05-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/eos/" itemprop="url" rel="index">
                    <span itemprop="name">eos</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/eos/Ethereum/" itemprop="url" rel="index">
                    <span itemprop="name">Ethereum</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/eos/Ethereum/经验杂谈/" itemprop="url" rel="index">
                    <span itemprop="name">经验杂谈</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Recently I read some of the source codes in <a href="https://github.com/EOSIO/eos" target="_blank" rel="noopener">EOS repo</a>. I find some interesting difference with EOS and ETH in code hierarchy. In ETH system design, they write Ether into the protocol itself, and the other tokens that users created is something in a higher level than Ether. However, in EOS system, EOS token is just a subclass of <a href="https://github.com/EOSIO/eos/blob/master/contracts/eosiolib/asset.hpp" target="_blank" rel="noopener">asset</a> class. You can create other assets which have your own custom token symbols. The EOS token’s token symbol is <code>S(4,EOS)</code>, which is a <code>uint64_t</code> type number. The value of this number is <code>1397703940</code> as EOSIO system token’s uid. EOSIO team defined EOS token symbol as <code>S(4, EOS)</code> in <a href="https://github.com/EOSIO/eos/blob/master/contracts/eosio.system/eosio.system.hpp" target="_blank" rel="noopener">eosio.system.cpp</a>. The block producer will gain this token, and action will consume this token. This is the fundamental differences between EOS token and other tokens which is also a subclass of assets. At this point, we can say EOS token and Ether’s function is almost the same - to be consumed for action or to stimulate the whole blockchain eco-system (reward to miner). Nevertheless the design on code hierarchy is different here. I am still a new learner of EOS, if u have any idea thanks for sharing your views.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fanyijie.net/2018/04/16/pitfalls-in-using-gasestimategas-and-getgasprice-function/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fan Yijie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fan's Home">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/16/pitfalls-in-using-gasestimategas-and-getgasprice-function/" itemprop="url">Pitfalls in using gasEstimateGas and getGasPrice function</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-16T19:11:01+08:00">
                2018-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ethereum/" itemprop="url" rel="index">
                    <span itemprop="name">Ethereum</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Pitfalls-in-getEstimateGas"><a href="#Pitfalls-in-getEstimateGas" class="headerlink" title="Pitfalls in getEstimateGas"></a>Pitfalls in getEstimateGas</h2><p>First let’s have a look at the offical doc about estimateGas function:</p>
<blockquote>
<p><strong>methods.myMethod.estimateGas</strong></p>
<p>myContract.methods.myMethod([param1[, param2[, …]]])<br>.estimateGas(options[, callback])</p>
<p>Will call estimate the gas a method execution will take when executed in the EVM without. The estimation can differ from the actual gas used when later sending a transaction, as the state of the smart contract can be different at that time.</p>
</blockquote>
<p>The description is not very clear here. In fact, estimateGas works by pretending the transaction was actually being included in the blockchain, and then returning the exact gas amount that would have been charged if that pretend operation was real. In other words, it uses the exact same procedure a miner would use to calculate the actual fee. It also means that estimateGas will not actually send a transaction. So someone would say if it works like that way, why we call it estimateGas rather than calculateGasNeeded. The reason is that if there is any way for the consequences of your transaction to change depending on when or to whom it is submitted, there is a potential for estimateGas to be wrong by arbitrarily large amounts. Detialed example can refer to reference[3], in these cases the estimation is unreliable.</p>
<h2 id="Pitfalls-in-getGasPrice"><a href="#Pitfalls-in-getGasPrice" class="headerlink" title="Pitfalls in getGasPrice"></a>Pitfalls in getGasPrice</h2><p>Now we move on to getGasPrice function. As we know, miners determine what gasPrice they are willing to accept. If the gasPrice is too small, the miner will ignore the transaction. And the offical doc about getGasPrice function is below:</p>
<blockquote>
<p><strong>getGasPrice</strong></p>
<p>web3.eth.getGasPrice([callback])</p>
<p>Returns the current gas price oracle. The gas price is determined by the last few blocks median gas price.</p>
</blockquote>
<p>Read carefully about this function, we can know it is just return the median gas price of last few blocks. And For I use ganache to test, the default gas Price should be 100000000000 wei. However the <code>web3.eth.getGasPrice()</code>function always return 20000000000 wei. This is where makes me confused. I solved this by assign a specific gas price for every transaction. Or you can simply ignore the <code>getGasPrice()</code> function and use the default value on ganache 100000000000 instead.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="http://web3js.readthedocs.io/en/1.0/web3-eth-contract.html?highlight=estimateGas#contract-estimategas" target="_blank" rel="noopener">estimateGas</a> [2] <a href="https://web3js.readthedocs.io/en/1.0/web3-eth.html#getgasprice" target="_blank" rel="noopener">getGasPrice</a> [3] <a href="https://ethereum.stackexchange.com/questions/266/what-are-the-limitations-to-estimategas-and-when-would-its-estimate-be-considera" target="_blank" rel="noopener">estimate Gas stackoverflow</a> [4] <a href="https://ethereum.stackexchange.com/questions/39173/what-is-the-actual-gasprice-used-in-a-truffle-ganache-environment?rq=1" target="_blank" rel="noopener">ganache gas price issue</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fanyijie.net/2018/04/11/error-vm-exception-while-processing-transaction-invalid-opcode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fan Yijie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fan's Home">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/11/error-vm-exception-while-processing-transaction-invalid-opcode/" itemprop="url">Error: VM Exception while processing transaction: invalid opcode</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-11T22:34:51+08:00">
                2018-04-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ethereum/" itemprop="url" rel="index">
                    <span itemprop="name">Ethereum</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天在<code>truffle test</code>时报了这个error，仔细检查后发现是在实现<code>_burn</code>函数时出错了。 其中的关键代码如下(Error code):</p>
<p>function _burn(address _owner, uint256 _tokenId) internal {</p>
<pre><code>...

uint256 tokenIndex = allTokensIndex\[_tokenId\];
uint256 lastTokenIndex = allTokens.length.sub(1);
Ware storage lastToken = allTokens\[lastTokenIndex\];

allTokens\[tokenIndex\] = lastToken;
delete allTokens\[lastTokenIndex\];

allTokens.length--;
allTokensIndex\[_tokenId\] = 0;
allTokensIndex\[lastToken.id\] = tokenIndex;

...
</code></pre><p>}</p>
<p>这里代码的预期功能是销毁一个指定所有者的特定ID的token，结果在测试时报了<code>invalid opcode</code>的错误。 为什么这里会报错呢，是因为写代码的时候忘记了Solidity的一个重要特性，对于storage类型的变量，在相互赋值时都是以引用的形式进行的。也就是说虽然<code>lastToken</code>是一个新建的变量，但是由于显式的声明为<code>stroage</code>，<code>lastToken</code>事实上只是一个引用reference，所以在执行<code>delete allTokens[lastTokenIndex];</code>时，lastToken也失效了，导致最后一句引用<code>lastToken.id</code>事实上是无效的。 然而代码仍然能够执行，是因为Solidity的另一个特性，<code>delete</code>的行为并不像通常的oop语言那样会删除这个对象，而是reset了这个对象，即把对象所有成员置0. 所以这段代码的<code>lastToken.id</code>永远为0. 下面给出正确代码 (Correct code):</p>
<p>function _burn(address _owner, uint256 _tokenId) internal {</p>
<pre><code>...

uint256 tokenIndex = allTokensIndex\[_tokenId\];
uint256 lastTokenIndex = allTokens.length.sub(1);
Ware storage lastToken = allTokens\[lastTokenIndex\];
uint256 lastId = lastToken.id;

allTokens\[tokenIndex\] = lastToken;
delete allTokens\[lastTokenIndex\];

allTokens.length--;
allTokensIndex\[_tokenId\] = 0;
allTokensIndex\[lastId\] = tokenIndex;

...
</code></pre><p>}</p>
<p>添加了<code>uint256 lastId = lastToken.id;</code>后，虽然<code>lastToken</code>的引用被<code>delete</code>了，但是<code>lastId</code>却被保留了下来，这样函数就可以得到正确执行了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fanyijie.net/2018/03/17/docker-crash-on-macos-10-12-when-add-registry-mirrors/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fan Yijie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fan's Home">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/17/docker-crash-on-macos-10-12-when-add-registry-mirrors/" itemprop="url">Docker在macOS 10.12上添加Registry Mirrors崩溃</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-17T18:07:25+08:00">
                2018-03-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术分享/" itemprop="url" rel="index">
                    <span itemprop="name">技术分享</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天在mac上给最新稳当版本docker(17.12)的gui上添加registry mirrors，点击apply&amp;restart后，docker就崩溃了无法打开了。经过试验，如果在daemon.json中手动添加registry-mirrors项再apply就不会出问题。由于没有获得diagnose id就没有提交issue了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fanyijie.net/2017/12/01/unity-compile-error-unable-to-convert-classes-into-dex-format/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fan Yijie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fan's Home">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/01/unity-compile-error-unable-to-convert-classes-into-dex-format/" itemprop="url">Unity Compile Error: Unable to convert classes into dex format</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-01T08:32:56+08:00">
                2017-12-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/unity/" itemprop="url" rel="index">
                    <span itemprop="name">unity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>tl；dr 在项目assets中搜索jar和aar文件，去掉其中重复的即可。 之前做Unity导出Android包的时候，发现报了一个编译错误，错误提示的title是Unable to convert classes into dex format，然后点进去有一串error。具体读了一下error信息，刚开始被其中的modern format dex误导了，后来再仔细看了一下，发现可能是指的多重引用的问题。error里面提到了几个库的名字，这几个库正好是shareSDK里面的。于是前往../Assets/Plugin/ShareSDK，果然里面有很多同一个公司的分享组件的不同版本的jar文件。于是把老版本的jar都删除了，只留下了最新版本，这个error就消除了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fanyijie.net/2017/09/19/compile-theory-semantic-analysis-and-code-generation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fan Yijie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fan's Home">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/19/compile-theory-semantic-analysis-and-code-generation/" itemprop="url">编译原理总结-语义分析与代码生成</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-19T13:13:54+08:00">
                2017-09-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术分享/" itemprop="url" rel="index">
                    <span itemprop="name">技术分享</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="输入输出的具体处理"><a href="#输入输出的具体处理" class="headerlink" title="输入输出的具体处理"></a>输入输出的具体处理</h4><p><em>i 输入</em> 这里的输入的语法分析树是一颗不平衡的多叉树，和最终的汇编代码形式区别较大。所以还需要进一步转化为抽象语法树才方便后面进行最终的代码生产。这里就首先自己用jdom库将tree.xml读入到Document对象中，再从根节点开始递归的进行处理。读入的具体实现可以在input函数中查看。递归处理转化则在traverseNode函数中，后面也会重点阐述着一块。 <em>ii 输出</em> 这儿我们首先明确输出对象是一份完整的汇编代码，这里考虑到规则集复杂度不高，我用了一个字符串来直接存储这个输出结果，最后输出到指定file中。同时对于辅助生成的AST，我也采用了jdom库在output函数中进行了输出。</p>
<h4 id="抽象语法树的生成"><a href="#抽象语法树的生成" class="headerlink" title="抽象语法树的生成"></a>抽象语法树的生成</h4><p>前面提到过语法分析树与最后的汇编代码形式差距较大，且冗余成分过多，不方便直接转化，所以首先我们要将语法分析树转化为抽象语法树。 对于抽象语法树，我是这么理解的：抽象语法树的设计事实上是具有一定自由度的，因为它是为了后面代码生成服务的，所以设计的目的是为了尽量方便后面的工作，同时让语法树尽量清晰简洁。因此不必拘泥于某种所谓的标准形式或者参考输出，只要方便简洁就好。 首先为了便于后面生成的时候对于并列语句进行循环生成，我转化的第一个目的就是把树变为平衡树。这一点我是通过traverseNode这个递归函数来实现的。这个递归函数有两个参数，一个是当前节点，另一个是准备作为父节点的节点。首先从根节点进入，然后根据当前节点类型，在switch语句中进入不同分支，通过在不同分支中选择性的创建新节点。因为可以把父节点通过该函数往下传递，就可以实现原本不同深度的节点被归并到同一层级的平衡效果。同时如果想增加节点，也可以通过调用makeNode函数得到指定的新节点，并将新节点作为新的父节点，作为traverseNode的parent参数，继续往下传递。这样在递归遍历分析树的同时，也就把新的抽象语法树由上到下的创建出来了。 通过这样parent的传递，树的平衡化就很好实现了，因为通常的语法结构只需要将下一层的结构提到上一层就可以了，比如分析树中并列的function会以下图形式体现 <img src="http://fanyijie.net/wp-content/uploads/2017/09/origin-format-1024x602.png" alt=""> 事实上我们只需要从根节点的functions进入，即调用traverseNode（functionsElement, parentElement）， 这里functionsElement即上图中树根处的functions节点，parentElement是树根处的functions节点之上没有画出来的父节点，它可能是Program节点或者其他任意可能作为funtions父节点的节点，比如另一个离树根更近的functions节点。 进入函数后，我们首先通过传入的第一个参数functionsElement来获取其function子节点，如果存在则用makeNode(functionElement, parentElement)将function节点和functions节点的父节点直接建立连接。这里注意makeNode的第一个参数只取输入节点本身，不包含输入节点下的子树。 然后我们再获取传入的参数——当前funcions节点——的functions子节点，并再次调用traverseNode(functionsElement, parentElement)，这里的fucntionsElement为树根处funtions节点的子节点中的functions节点，parentElement和之前第一次调用相同，为树根处中functions节点的父节点。这样就实现了把这个总的父节点传递下去，这样不断往下递归，就可以建立一颗以树根处functions的父节点为父节点，下方所有function节点为子节点的平衡多叉子树了。也就和function实际上在代码中的并列关系对应了起来。以根节点的父节点为Program为例，转化效果如下 <img src="http://fanyijie.net/wp-content/uploads/2017/09/dest-format-1024x309.png" alt=""> 这里要注意一个特殊的地方，那就是对于表达式的变换过程。根据pdf可以看到表达式的子树标准形式如下 <img src="http://fanyijie.net/wp-content/uploads/2017/09/balance-tree.png" alt=""> 而现有的形式如下 <img src="http://fanyijie.net/wp-content/uploads/2017/09/analysis-tree.png" alt=""> 这个转化和其他通常的语法结构的转化有一定区别， 因为不仅要转化为平衡树，还需要对操作符节点所处的位置进行变换，将操作符作为每一个子树的父节点，而变量标识符或者常量则作为子树的子女。我采取的办法是做两趟处理。第一趟处理和前面一样，将树转化为平衡树，第二趟处理则在平衡树的基础上将节点的位置进行变换。 这里处理的关键在于第二趟，对于term和expr两个类似但有有区别的语法结构，我分别写了transformTerm和transformExpr两个函数来处理。其中transformTerm是最下层的函数，负责将平衡的并列结构用循环的方式按照结合性依次形成上图中从下到上两两结合的标准AST子树。而transfromExpr由于还要其子树的子女不仅仅是操作符或者常量变量这三种情况，还有可能是之前形成的term结构，所以在构建新节点时，不能仅仅使用只拷贝当前节点的makeNode，而需要使用拷贝当前节点及其子树的makeCloneNode，这样才能将整个term子树和expr子树结合在一块来。 因为第一趟不是最终的形式，所以就不需要加入到AST子树中了，只需要将第一趟得到的平衡子树根节点传递给相应的transform函数，再将变形后子树的根节点用makeCloneNode结合到父节点就可以了。这一点可以在tranverseNode函数的相应case中看到。</p>
<h4 id="符号表的设计"><a href="#符号表的设计" class="headerlink" title="符号表的设计"></a>符号表的设计</h4><p>虽然说课程要求中说可以不做语义分析。但是要生成代码，符号表还是必要的。这里由于设计的比较简单，就只用了一个大的函数表，以函数名作为key，存储有相应的函数类型，参数名称类型以及个数，以及函数内部变量表。 函数内部变量表是Dictionary类型的，以变量名为key，存储有变量类型，变量地址，以及变量值。 这里变量地址涉及到了寄存器。这里用枚举类RegType标记了寄存器类型，并建立了Reg类以生成寄存器对象，方便调用和存储。</p>
<h4 id="寄存器分配"><a href="#寄存器分配" class="headerlink" title="寄存器分配"></a>寄存器分配</h4><p>因为要生成代码，所以寄存器分配是必须考虑的问题。这里我采用的策略如下： （1） 变量值已经在寄存器中，直接调用寄存器 （2） 变量尚未分配寄存器，此时有空的寄存器或者内容已经不需要的寄存器，就把变量分配给这个寄存器。 （3） 变量尚未分配寄存器，但是没有空寄存器，则暂时保存某个寄存器内容到内存，然后再把该变量存到指定寄存器。 其中将寄存器内容保存到内存时，应该采用下次使用位置离现行位置最远的变量所在寄存器。不过这样需要有一趟语义分析的过程，以获得该临时变量在何处引用的信息。这里暂时任意选取一个来保存的，还需要后面进行进一步完善分析。 除了通用的策略，还要注意mips自身的寄存器规则。比如v0, v1是返回值专用，t0-t9是函数调用时被调用者可以直接使用的临时寄存器， a0-a3是前四个参数传递的寄存器等。我在这里建立isTempRegFree以及TempReg等多个全局数组来对这些寄存器进行管理，然后用getTempReg（）等一系列方法来实现寄存器的分配。从而在调用时无需考虑过多的寄存器细节，只需要调用相应分配寄存器函数获得Reg寄存器对象即可，具体的分配细节都被隐藏在了getTempReg等一系列函数中。</p>
<h4 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h4><p>这里是通过一趟遍历AST并根据不同语句调用不同的codeGen函数来生成代码的。遍历操作在traverseAST函数中。这里用循环对函数进行遍历，首先读入当前函数信息后，填充相应函数表，再对当前函数的语句调用traverseStmt函数进一步递归遍历。 在traverseStmt中，通过switch对不同类型的语句调用了不同的操作进行翻译。对于声明语句，只需要调用寄存器分配函数分配并加入到当前函数的临时变量表即可，无需生成实际代码。 对于返回语句和赋值语句，都涉及到了一个重要的部分，对表达式语句的翻译。 这里由于前面的步骤已经将表达式语句转化为了标准的AST，这里用一个traverseExpr（）函数对当前表达式的AST子树递归进行代码生成，并获取到每一步的结果寄存器即可。 这里对左右子树进行递归，只要子树节点为操作符的，就继续调用traverseExpr（）函数进行递归，并将递归返回的结果寄存器作为当前步的左操作符所在寄存器或者当前步的右操作符寄存器。对于操作符是常量的，则额外调用genLi函数将常量置于寄存器中，并得到常量所在寄存器；对于操作符是变量的，则用findReg函数在变量表中查找变量所在寄存器。获得左右操作符地址（所在寄存器）后，再根据操作符类型，调用相应的gen函（）数生成相应代码并获得结果所在寄存器。 其中要注意mips中的除法结果不能直接获取，还需要用mflo指令在特殊寄存器Lo中获取。 这样对于每次有表达式的地方，只需要调用traverseExpr（）函数即可获得表达式最终结果的寄存器，并已经按序生成了中间代码，然后再根据调用处的需要对结果所在寄存器进行处理即可。 处理了表达式，接着就要处理另外一类重要的语句处理，跳转语句。跳转语句在循环结构和分支结构中都会涉及。 跳转本身在mips语言里很简单，只需要根据条件语句的情况，调用相应的跳转语句就行了。关键在于跳转语句中的target，即要跳转到的位置。这里我用标号的形式来表示跳转位置。 这里考虑到可能有多个循环以及嵌套循环，或者多个分支以及嵌套分支，所以使用了两个计数器ifcount和whilecount分别为循环和分支计数，每次进入一个语句后马上增加相应计数器并生成该语句对应需要的所有标号，这样就保证了标号的一一对应和唯一性。 具体来说，比如对于ifelse语句，在else前会有一个专用于else前的标号，标号被当前if语句唯一确定，由于语句所需标号预先已经知道并全部生成，从而在分支跳转语句中可以直接前往这个标号，而不需要拉链反填。而在语句最后会有一个与ifcount结合的out标号，作为语句结束的标记。从而在if语句结束时可以直接挑转到这儿。 再比如对于while语句，进入后会先生成两个与当前语句相关联的唯一标号，分别对应循环开始和循环结束。这样分支跳转语句中可以直接在相应情况下跳转到循环结束位置，而循环末尾处也可以无条件跳转到循环开始的判断语句位置。 由于计数器是单增且标号是进入语句即确定的，所以即使有嵌套循环也不会产生标号混乱的情况。这样就把当前语言子集下的标号问题解决了。</p>
<h4 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h4><p>根据上述思考的结果，我将语法分析器的函数分为了主函数，初始化函数，输入函数，AST生成函数，AST遍历函数，寄存器分配函数，符号表函数，代码生成函数，输出函数以及一些为了代码重用而实现的辅助类函数。 主函数中依次调用输入函数，初始化函数，输入函数（在输入函数中调用了AST生成函数），AST遍历函数（在AST遍历中调用了代码生成函数和寄存器分配函数以及符号表函数），输出函数。即为代码生成的整个流程。 输入函数则简单的完成自己基本的输入逻辑即可，其中没有业务逻辑。 AST生成函数则通过多个递归函数以及构造连接节点的辅助函数将原本输入的语法分析树转化为抽象语法树。 寄存器分配函数则通过一系列相关函数为代码生成做好准备，隐藏具体的分配细节。 符号表函数则是提供符号表的插入和查询等操作，为代码生成做好准备。 AST遍历函数则负责通过循环和递归结合，遍历之前生成的AST，在这个过程中调用相应的代码生成函数生成最终代码。 最后调用输出函数将得到的目标代码输出即可。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fanyijie.net/2017/09/19/compile-theory-syntactic-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fan Yijie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fan's Home">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/19/compile-theory-syntactic-analysis/" itemprop="url">编译原理总结-语法分析</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-19T13:08:18+08:00">
                2017-09-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术分享/" itemprop="url" rel="index">
                    <span itemprop="name">技术分享</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="输入输出的具体处理"><a href="#输入输出的具体处理" class="headerlink" title="输入输出的具体处理"></a>输入输出的具体处理</h4><p><em>i 输入</em> 这里的输入实际上仅仅是一个tokens数组而已，很好处理，只需要读入xml，然后找到tokens这个XML项，然后对其子节点依次解析，将每个filed存入我们临时创建的一个token中，再对每一个子节点将这个临时token加入tokens数组容器即可，类似于反序列化的过程。具体实现可以在input函数中查看。 <em>ii 输出</em> 这儿我们首先明确输出对象是一颗语法分析树，所以我们需要一个多叉树的数据结构来存储这个输出结果。这里由于采用了jdom库作为xml输出，其中已经有了一个Element类型可以作为多叉树的节点使用（XML文件本身就是具有多叉树形式的）， 所以我就直接借用了jdom的Element类型作为我们语法分析树的节点类型。在这里整个输出流程就被划分为了构造和真正输出两部分。 事实上这儿也有两种策略选择，一种方式是只进行简单的构造，例如将语法树的元素直接add进一个数组并做一些结构化的标记，然后在输出时再通过较为复杂的方式将结果重新组织为语法树的形式输出。也可以在构造时直接构造为一颗完整的树，输出时直接从树的根节点开始顺序输出就行了。 正如之前所说，由于我采用了jdom的Element类型作为节点类型，所以显然最简单的方式就是在我进行语法分析时同时构造一颗完整的语法树，这样最后直接将整个语法树的根节点调用jdom库的标准输出就可以了。</p>
<h4 id="具体实现策略的选择"><a href="#具体实现策略的选择" class="headerlink" title="具体实现策略的选择"></a>具体实现策略的选择</h4><p>语法分析器一般有两种大的设计思路：自顶向下设计和自底向上设计。 自顶向下设计也被称为预测性语法分析，它从语法分析树的树根开始，系统化的向下扩展树，直至树的叶结点与词法分析器返回的已归类单词匹配。它的特点是紧凑而高效。可以用递归下降或是LL（1）（表驱动或直接编码的）来实现。并且因为在语法分析过程中的每一点，这种语法分析器都知道可以作为有效输入串中下一个符号出现的单词集，因而可以产生精确而有用的错误信息。它的主要缺点在于无法处理左递归，与右递归相比，左递归文法用一种更自然的方式建立了表达式运算符从左到右的结合性的模型。至于回溯方面，由于大多数程序语言结构都可以用无回溯语法表达，所以在这一点上对自顶向下分析的应用影响不大。 自底向上分析是指从叶结点开始构建语法树，自叶结点向根节点方向进行的分析方法。语法分析器对词法分析器返回的每个单词分别构建一个叶节点，这些叶结点形成了语法分析树的下边缘。为了构建一个推导，语法分析器需要根据语法和语法分析树完成的底部，在叶结点之上添加非终结层。它的语言适应范围比自顶向下更广，即使是左递归文法和左公因子的文法也能正确处理。通常使用表驱动的LR（1）语法分析来实现。 这里由于我们的文法较为简单，而且在设计的时候已经消除了左递归和左公因子，所以非常适合自顶向下的语法分析器。并且一个构建良好的递归下降语法分析器可以比表驱动的LR（1）语法分析器更加迅速，所以我选择了递归下降的方法来实现语法分析器。尽管LR（1）的直接编码方案可以胜过递归下降，但是考虑到自顶向下的递归下降语法分析器是最容易以手工编码的方式构建的，所以还是没有采用直接编码的LR（1）。此外，递归下降语法分析器相比LR（1）在错误处理方面更有优势，并且更容易处理语言中的二义性。 这里我们通过检查前瞻符号和First集合来消除自顶向下分析中产生式子的不确定性，这样就可以避免递归中的回溯。整个策略就是对于文法每一个非终结符，我们构建一个函数来识别与之匹配的各个产生式的右侧句型。这些过程按照设计的文法规则彼此嵌套调用，以识别对应的非终结符。终结符的识别在这里为了便于输出，通过简单的匹配函数进行。</p>
<h4 id="非终结符识别函数的设计"><a href="#非终结符识别函数的设计" class="headerlink" title="非终结符识别函数的设计"></a>非终结符识别函数的设计</h4><p>对于递归下降函数，最关键的部分就是程序的主体———非终结符识别函数的设计了。首先要考虑的是函数返回的设计。因为在识别的过程中，尽管这里已经消除了回溯再识别的情况，但是仍然难以避免存在识别失败的情况。这时有两种解决方案，一种是直接在最底层报告错误然后结束程序，另一种是逐层上报，在适当的分析层上报告相应信息并尝试恢复或者停止分析。这里我因为一开始想检测文法是非为回溯文法，以及想进行一些错误恢复工作而选择了后者。这样的话，每个函数必须有一个布尔型的返回值来指示其解析是否成功。 除了返回值，函数的参数也是需要考虑的一个点。这里同样有两种选择方案。一种是保持为空，然后依靠输出一些结构性语句来在线性的数组中维持一个树的结构。另一种是直接传入父节点，然后如果识别成功就把在当前识别函数中新建的节点加入到父节点中。这里采用了后者来实现，因为这样先构建一颗完整的语法树再直接输出的方式更为直接，而且实现更加简洁。为了避免代码重复，这儿我把成功识别并加入父节点的逻辑和返回值的操作进行了合并，合并到了一个succ()函数中。而对于空节点和失败识别的操作也做了类似的处理，分别对应程序中的pushNull()和fail()函数。其中fail()函数中还包含了错误处理的逻辑。 此外就是整个token数组指针的移动问题，为了得到一个更清晰的逻辑，这里将指针移动都放入了识别终结符的匹配函数中，因为识别非终结符本身是不需要移动指针的，构建过程只是在上层完成，只有对叶子上终结符的识别完成，才会需要移动指针。将这个操作封装进匹配函数而不是裸露在非终结符的识别函数中，可以保持实现的简洁和逻辑的清晰，在函数中只需要按照文法依次调用即可。 对于token数组指针移动，还有一个先后问题。这里选择了只有匹配成功才移动，如果失败时不会移动。对于识别的时候也是，只有识别成功的时候才会加入父节点，不然就不会操作。这样做主要是避免了潜在的回退或者删除节点的操作，提高了效率，实现上也更加简洁。 另外，对于文法中存在“||”或的地方，我们需要对下一个token和first集进行匹配检查，以确定应该进入或的哪一项，或是匹配失败。这里我建立一组单独的检查函数来进行。它和终结符的匹配函数的区别主要在于检查函数的调用不会引起token数组指针的移动。 例如下图即为实现while语句识别的函数，为了便于修改保留了if的所有大括号。 下图是识别statement list的函数，其中可以看到提前对空集情况的first集进行了判断，从而避免了回溯。</p>
<h4 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h4><p>根据上述思考的结果，我将语法分析器的函数分为了流程函数，控制函数，终结符匹配函数，检查函数，非终极符识别函数，输入输出函数以及一些为了代码重用而实现的辅助类函数。 流程函数类似于主函数，在其中依次调用输入函数，初始化函数，分析树根节点的识别函数，输出函数。 输入输出函数则简单的完成自己的输入输出基本逻辑即可，其中没有业务逻辑。 控制函数这里其实就是next()函数，负责取下一个token以及潜在的避免越界的限制。 终结符匹配函数是负责直接匹配终结符的，它同样以父节点为参数，如果识别成功该终结符，它将新建这个终结符的节点并把终结符的value设置进节点的text域中，再把该节点加入到父节点中，并前进一个token指针。如果识别失败，则直接返回fail()。 检查函数则是为了检查当前token和first集是否一致的，一致则返回true，不一致则返回false。它是为了在识别非终结符中避免回溯服务的。</p>
<h4 id="文法设计"><a href="#文法设计" class="headerlink" title="文法设计"></a>文法设计</h4><p>根据前面的分析，整个语法分析器的骨架已经有了，现在给出文法设计来填充这个分析器。事实上文法设计我是第一步做的，因为语法分析器的设计本身就是基于文法的，如果没有确定文法，那么具体架构的设计也就无从得知了。 这里我设计的文法涵盖了局部变量声明，赋值语句，返回语句，if语句，if-else语句，while循环语句，更多的文法由于时间原因尚未实现，就先去除了。这里采用了ANTLRWorks的格式书写, 冒号：代表语法右部开始，竖线| 代表或，分号；代表一个文法项的结束，括号（）表示了优先级。 <code>CMPC_UNIT:FUNC_LIST; FUNC_LIST:FUNC_DEF FUNC_LIST|; FUNC_DEF:TYPE_SPEC ID &#39;(&#39;PARG_LIST&#39;)&#39; &#39;{&#39;STMT_LIST’}’; FUNC_TYPE: TYPE|’void’; TYPE_SPEC: ‘int’|’float’|’char’|’double’; PARG_LIST:(TYPE_SPEC ID (’,’PARG_LIST)|)|; STMT_LIST:(STMT STMT_LIST)|; STMT:RTN_STMT|ASSIGN_STMT|WHILE_STMT|BRANCH_STMT|DECLARE_STMT; RTN_STMT:&#39;return&#39; EXPR ‘;’; DECLARE_STMT: TYPE_SPEC ID ID_LIST ’;’; ID_LIST: (‘,’ ID ID_LIST) |; ASSIAN_STMT:TYPE_SPEC|ε ID&#39;=&#39;EXPR ‘;’; EXPR:TERM EXPR2; EXPR2:(&#39;+&#39; TERM EXPR2)|(&#39;-&#39; TERM EXPR2)|; TERM:FACTOR TERM2; TERM2:(&#39;*&#39; FACTOR TERM2)|(&#39;/&#39; FACTOR TERM2)|; FACTOR:ID|CONST|(&#39;(&#39;EXPR&#39;)&#39;); WHILE_STMT:&#39;while’’(‘JU_STMT&#39;)&#39;&#39;{&#39;STMT_LIST&#39;}&#39;; BRANCH_stmt:’if’ ‘(‘JU_STMT’)’ ‘{‘stmt list’}’ (else ‘{‘stmtList’}’ )|; JU_STMT:FACTOR (JUDGE_OP FACTOR)|; JUDEG_OP:’&lt;‘|’&gt;’|’&lt;=‘|’&gt;=‘; ID: (&#39;a&#39;..&#39;z&#39;|&#39;A&#39;..&#39;Z&#39;)+ (&#39;a&#39;..&#39;z&#39;|&#39;A&#39;..&#39;Z&#39;| &#39;0&#39;..&#39;9&#39;)* CONST:( ‘0’..’9’)*</code> 经过检查可以发现，该文法没有左递归和左公因子，可以直接用于递归下降语法分析器。</p>
<h4 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h4><p>选用递归下降的一个原因就是用它可以方便的进行错误处理。这里对于错误处理主要由两种措施，一是报告错误，二是修正错误。这里选取第一种方式，也是更加常见的方式。此外，还有两种处理策略，一是遇到错误就停止，二是继续尝试分析。明显第二种方式更好，因为程序员编写程序过程中可能会有多个错误，通过第二种方式能够发现在一次编译中发现更多的错误。 因此我们需要建立一种机制，使得语法分析器能够从错误中恢复，转移到另一个状态，从而继续进行语法分析。这种机制通常是选择一个或多个单词作为同步词，每当遇到一个错误时，它将不断丢弃单词直到找到一个同步词，然后从这个同步词一致的状态继续开始分析。 在本程序的递归下降中，只需要遇到错误时不断丢弃token，直到遇到分号为止。此时语法分析器将控制转移到解析语句例程报告成功的位置。这里由于时间关系暂时只实现了在合适的位置报告解析错误的位置以及相应的单词的错误处理，但是已经预留了相应的接口为之后的改进做准备。毕竟如果使用一个一次编译只能发现一个错误的编译器来编译，那真的会是一个冗长而费力的过程。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fanyijie.net/2017/09/19/compile-theory-lexical-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fan Yijie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fan's Home">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/19/compile-theory-lexical-analysis/" itemprop="url">编译原理总结-词法分析</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-19T13:06:08+08:00">
                2017-09-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术分享/" itemprop="url" rel="index">
                    <span itemprop="name">技术分享</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="输入输出的具体处理"><a href="#输入输出的具体处理" class="headerlink" title="输入输出的具体处理"></a>输入输出的具体处理</h4><p><em>i 输入</em> 这里采用了双缓存来作为基本的输入模式。即先读入一定量的字符到某一缓存中，每当将要访问到这一缓存尽头时，就提前读入下一缓存，这样交替循环。其思想和计算机图像学中的双缓存是一致的，都是为了在内存有限的前提下，保证运行的连续性。支撑这种模式的根本原因应该是cpu处理和IO处理速度的不一致性。由于CPU速度远远大于IO，而这里处理单个字符的时间复杂度又是O（1）的一个小数量级，所以IO是这一类程序运行的主要瓶颈。这里通过double buffer的策略，就很好的平衡了IO与CPU速度的差距，同时保证了内存的消耗不会过大。但是这里要注意一点，就是单个缓存区不能开的过小，不然频繁的IO将对整个系统的运行产生灾难性的影响。查阅相关文献可以发现，如果缓冲区的大小设定有着较强的敏感性，过低或过高，都将对速度以及内存消耗产生剧烈的影响。 不过我们这儿由于测试过程中读入的程序文件都较小，且计算机的内存较大，所以影响还不够明显，暂时设定为一个文献参考值8000 char作为我们的基准。 在具体实现方面，由于采用了双缓存策略，每次都将从上一次读入结束的位置开始读入一个固定的量，所以这里采用了BufferReader和InputSteamReader结合的方式来实现这样的读取。通过BufferReader的skip函数即可实现我们想要的功能。 <em>ii 输出</em> 这里直接使用了jdom库作为xml输出，这里建立一个Token的java bean作为输出的对象。在ouput方法中遍历Token的Array即可实现，这个地方较为简单，就略过了。</p>
<h4 id="具体实现策略的选择"><a href="#具体实现策略的选择" class="headerlink" title="具体实现策略的选择"></a>具体实现策略的选择</h4><p>词法分析器一般有三种实现方法，一是通过第三方库自动生成，比如lexAnalysis等已经比较成熟的三方库都可以，他们往往是表驱动的。当然也可以直接写一个转移表来实现。但是这样生成的词法分析器在性能上往往有所欠缺。更进一步就是直接编码，通过代码上的跳转来代替查表的开销。但是这样写出的代码往往可读性比较差，不利于后面的维护与修改。 这里我采用了基于while循环和switch语句的手工编码策略。在最大化性能与高灵活性的前提下，尽量提高了代码的可读性。当然也有缺点，那就是大量的case与if else，以及繁复的思考过程。要实现C11的标准，事实上还需要更多的考量，因为c语言编译器的各个步骤不是完全分开的，它还有很多的编译选项（CPP_OPTION），这个由于框架的局限性暂时无法完全实现。不过对于核心的语法部分，还是可以通过合理的安排case较好的实现的。 之所以选择switch作为主要分支而不是if else，主要是基于两方面的考虑。 一是从汇编的角度考虑，面对大量的分支，switch是优于if else的，因为在底层可以通过一个转移表来实现一次性转移，而节省了大量的cmp或者test的开销。 二是从可读性的角度考虑，面对大量分支，case往往比if’ else更加清晰。 除此之外，由于是手工编码，并且采用双缓存模式，所以可以不需要逐字的循环，每一次循环都表示一个单词处理的完成。这样整个效率也可以得到较大的提升。 另外为了降低耦合度，使整个代码更加清晰，参考了一些成熟开源编译器的做法，对于每一种类型具体的识别和处理，我分别采用了单独的函数进行更加细致和具体的处理，其中包括了Token的填充逻辑。</p>
<h4 id="关键字的识别"><a href="#关键字的识别" class="headerlink" title="关键字的识别"></a>关键字的识别</h4><p>关键字的识别无疑也是一个重点。对于手动编码来说，如果要将关键字的识别与标识符的识别提到同等地位，这是有点难以接受的。因为即使你用switch为主导来实现，这也是基于背后隐含的自动机转移而实现的。如果加入了整体关键字，那整个状态数将会急剧的增长，而且如果你在日后想要更新关键字，不管是增加还是删除，都需要再一次的计算整个自动机。 所以基于状态数的控制以及可维护性这两方面，我决定将关键字作为标识符的二次判断来进行。即先识别是否是标识符，如果的确是标识符的话，再识别其是否是关键字。 这里对于最后的判断是否是关键字，处于性能上的考虑，我采取了hash的策略。即在程序设计之初，就把关键字全部储存为其hash值，而不需要存储关键字本身。在词法分析的时候，也只需要将当前单词的hash值与存储的hash值比较即可。这样做的原因是因为比较两个整数是否相等对于计算机只需要一个机器码即可，而比较字符串的相等的消耗就要大得多了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Fan Yijie</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">38</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/fan31415" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="fanyije@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fan Yijie</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
